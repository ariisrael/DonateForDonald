var charities = [{
        ein: '13-3871360',
        name: 'American Civil Liberties Union Foundation',
        site: 'www.aclu.org',
        alias: 'ACLU',
        twitter: ['@ACLU']
    }, {
        ein: '52-1481896',
        name: 'Human Rights Campaign Foundation',
        alias: 'HRC',
        site: 'www.hrc.org',
        twitter: ['@HRC']
    }, {
        ein: '13-2654926',
        name: 'Natural Resources Defense Council',
        site: 'www.nrdc.org',
        alias: 'NRDC',
        twitter: ['@NRDC']
    }, {
        ein: '13-1644147',
        name: 'Planned Parenthood Foundation of America',
        alias: 'PPFA',
        twitter: ['@PPFA', '@PPact'],
        site: 'www.plannedparenthood.org'
    }, {
        ein: '13-1818723',
        name: 'Anti-Defamation League',
        alias: 'ADL',
        site: 'www.adl.org',
        twitter: ['@ADL_National']
    }, {
        ein: '95-4539765',
        name: 'National Immigration Law Center',
        alias: ['NILC'],
        twitter: ['@NILC_org'],
        site: 'www.nilc.org'
    }, {
        ein: '22-6082880',
        twitter: ['@theCCR'],
        name: 'Center for Constitutional Rights',
        alias: ['CCR'],
        site: 'www.ccrjustice.org'
    }, {
        ein: '13-1655255',
        name: 'NAACP Legal Defense and Educational Fund',
        alias: 'LDF',
        site: 'www.naacpldf.org',
        twitter: ['@NAACP_LDF', '@NAACP']
    }, {
        ein: '77-0646756',
        name: 'Council on American-Islamic Relations Foundation',
        alias: 'CAIR',
        site: 'www.cair.org',
        twitter: ['@CAIRNational']
    }, {
        ein: '04-3091431',
        name: 'Electronic Freedom Foundation',
        alias: 'EFF',
        site: 'www.eff.org',
        twitter: ['@EFF']
    }, {
        ein: '06-0726487',
        name: 'Save the Children',
        site: 'www.savethechildren.org',
        twitter: ['@SaveTheChildren']
    }, {
        ein: '52-1343924',
        name: 'Government Accountability Project',
        alias: 'GAP',
        twitter: ['@GovAcctProj'],
        site: 'www.whistleblower.org'
    }, {
        ein: '32-0077563',
        twitter: ['@innocence'],
        name: 'Innocence Project',
        site: 'www.innocenceproject.org'
    }, {
        ein: '14-2007220',
        name: 'ProPublica',
        site: 'www.propublica.org',
        twitter: ['@ProPublica']
    }, {
        ein: '52-1388917',
        name: 'Conservation Fund',
        site: 'www.conservationfund.org',
        twitter: ['@ConservationFnd']
    }, {
        ein: '13-3081500',
        name: 'Committee to Protect Journalists',
        alias: 'CPJ',
        site: 'www.cpj.org',
        twitter: ['@pressfreedom']
    }, {
        ein: '53-0196605',
        name: 'American Red Cross',
        site: 'www.redcross.org',
        twitter: ['@RedCross']
    }, {
        ein: '31-1580204',
        name: 'Clinton Foundation',
        alias: 'CF',
        twitter: ['@ClintonFdn', '@HillaryClinton'],
        site: 'www.clintonfoundation.org'
    }, {
        ein: '13-1760110',
        twitter: ['@UNICEF'],
        name: 'United States Fund for UNICEF',
        site: 'www.unicefusa.org'
    }, {
        ein: '20-2370934',
        name: 'Wounded Warrior Project',
        site: 'www.woundedwarriors.org',
        alias: ['WWP'],
        twitter: ['@WWP']
    }, {
        ein: '63-0598743',
        name: 'Southern Poverty Law Center',
        alias: ['SPLC'],
        site: 'https://www.splcenter.org/',
        twitter: ['@splcenter']
    }, {
        ein: '36-3241033',
        name: 'American Refugee Committee',
        alias: 'ARC',
        site: 'www.arcrelief.org',
        twitter: '@ARCrelief'
    }, {
        ein: '52-1477004',
        name: 'National Organization for Women Foundation',
        alias: 'NOW',
        site: 'www.now.org',
        twitter: ['@NationalNOW']
    }, {
        ein: '46-2216565',
        name: 'United We Dream',
        site: 'http://unitedwedream.org/',
        alias: 'UWD',
        twitter: ['@UNITEDWEDREAM']
    }, {
        ein: '52-1662800',
        name: 'United Nations High Commissioner for Refugees',
        site: 'http://www.unrefugees.org/',
        alias: 'UNHCR',
        twitter: ['@Refugees', '@unhcr', '@UNRefugeeAgency']
    }, {
        ein: '95-4681287',
        name: 'The Trevor Project',
        site: 'http://www.thetrevorproject.org/',
        twitter: ['@TrevorProject']
    }, {
        ein: '77-0071852',
        name: 'Black Lives Matter',
        site: 'http://blacklivesmatter.com/',
        alias: 'BLM',
        twitter: '@Blklivesmatter'
    }, {
        ein: '94-6069890',
        name: 'Sierra Club Foundation',
        site: 'http://www.sierraclubfoundation.org',
        alias: 'SCF',
        twitter: ['@SierraClub']
    }, {
        ein: '13-2875808',
        name: 'Human Rights Watch',
        site: 'http://www.hrw.org/',
        alias: 'HRW',
        twitter: ['@hrw']
    }, {
        ein: '52-0851555',
        name: 'Amnesty International USA',
        site: 'www.amnestyusa.org/',
        twitter: ['@amnesty']
    }, {
        ein: '74-1563270',
        name: 'Mexican American Legal Defense and Educational Fund',
        alias: 'MALDEF',
        site: 'www.maldef.org/',
        twitter: ['@MALDEF']
    }, {
        ein: '04-2535767',
        name: 'Union of Concerned Scientists',
        alias: 'UCSUSA',
        site: 'www.ucsusa.org/',
        twitter: ['@UCSUSA']
    }, {
        ein: '11-6107128',
        name: 'Environmental Defense Fund',
        alias: 'EDF',
        site: 'https://www.edf.org/',
        twitter: ['@EnvDefenseFund']
    }, {
        ein: '13-3447888',
        name: 'PEN America',
        site: 'https://pen.org/',
        twitter: ['@PENamerican']
    }, {
        ein: '95-3313195',
        name: 'Greenpeace Fund',
        site: 'http://greenpeacefund.org/',
        twitter: ['@Greenpeace']
    }, {
        ein: '52-1218336',
        name: 'People for the Ethical Treatment of Animals',
        alias: 'PETA',
        site: 'http://www.peta.org/',
        twitter: ['@peta']
    }, {
        ein: '52-1693387',
        name: 'World Wildlife Fund',
        alias: 'WWF',
        site: 'https://www.worldwildlife.org/',
        twitter: ['@WWF']
    }, {
        ein: '13-3433452',
        name: 'Doctors Without Borders',
        alias: 'MSF',
        site: 'http://www.doctorswithoutborders.org/',
        twitter: ['@MSF_USA', '@MSF']
    }, {
        ein: '13-5660870',
        name: 'International Rescue Committee',
        alias: 'IRC',
        site: 'https://www.rescue.org/',
        twitter: ['@theIRC']
    }, {
        ein: '35-1019477',
        name: 'Heifer Project International',
        site: 'https://www.heifer.org/',
        twitter: ['@heifer']
    }, {
        ein: '91-1148123',
        name: 'Mercy Corps',
        site: 'https://www.mercycorps.org/',
        twitter: ['@mercycorps'],
    }, {
        ein: '23-7069110',
        name: 'Oxfam America',
        site: 'https://www.oxfamamerica.org/',
        twitter: ['@Oxfam', '@OxfamAmerica']
    }, {
        ein: 'â€Ž46-4950751',
        name: 'Obama Foundation',
        site: 'https://www.obama.org/',
        twitter: ['@ObamaFoundation', '@BarackObama']
    }, {
        ein: '13-5563422',
        name: 'Catholic Relief Services',
        alias: 'CRS',
        site: 'www.crs.org/',
        twitter: ['@catholicrelief']
    }
];


$(document).ready(function () {
  // Toggle amount selector buttons between active/inactive
  $(".toggle")
    .on('click', function () {
      $(this).toggleClass('selected-amount');
      $(".selected-amount").not(this).removeClass('selected-amount');
      $(".js-amount-other input").prop("disabled", true);
      $(".dollar-sign").addClass("greyed-out");
      $(".js-amount-other input").val("");
      $(".js-amount-other input").prop("placeholder", "25");
    });
  // User clicked other amount input
  $(".js-amount-other")
    .on('click', function () {
      // Enable text field
      $("input", this).prop('disabled', false);
      $(".dollar-sign").removeClass("greyed-out");
    });

  // User toggles maximum monthly donation
  $(".js-maximum-toggle")
    .on('click', function () {
      $('.js-maximum-amount').toggleClass('disabled');
    });

  // User started typing other amount
  $(".js-amount-other input")
    .on('focus', function () {
      // Clear placeholder text when user clicks input
      $(this).prop("placeholder", "");
    });
  // User clicked 'View Tweets'
  $('.js-tweets')
    .on('click', function () {
      if ($('.js-tweet-drawer').hasClass('visible')) {
        $(this).html('<i class="twitter icon"></i> View Tweets');
        $('main').css('overflow-y', 'auto');

      } else {
        // Switch button to hide tweets
        var trigger = $('input[name=trigger]').val().trim();

        loadTweets(trigger);
        $(this).html('<i class="cancel icon"></i> Hide Tweets');
        $('main').css('overflow-y', 'hidden');
        $('body').css('overflow-y', 'hidden');
        $('html').css('overflow-y', 'hidden');

      }
      $('.js-nav').removeClass('visible');
      // Open drawer w/ tweet list
      $('.js-tweet-drawer').toggleClass('visible');

    });
  // User clicked 'x' to close tweets
  $('.js-close-tweets')
    .on('click', function () {
      $('.js-tweet-drawer').removeClass('visible');
      $('.js-tweets').html('<i class="twitter icon"></i> View Tweets');
      $('.js-nav').addClass('visible');
      $('main').css('overflow-y', 'auto');
      $('body').css('overflow-y', 'auto');
      $('body').css('overflow-x', 'hidden');

      $('html').css('overflow-y', 'auto');
      $('html').css('overflow-x', 'hidden');
    });
  // User selected dropdown option
  $('.selection').dropdown({
    onChange: function (value) {
      $('.demo.icon').popup({ transition: value }).popup('toggle');

}
  });

  // Update tweet count
  $('.js-tweet-count').text();

  // User clicked 'donate' button
  $('.js-donate button').on('click', function () {
  })
  // User clicked 'login' button
  $('.js-login button').on('click', function () {
  });

  noLinkReload();

  var rawTrigger = localStorage.getItem('trigger');
  if(rawTrigger) {
    var userTrigger = JSON.parse(rawTrigger);
    $('.js-trigger-label').attr('data-content', userTrigger.name);
    $('.js-charity-label').attr('data-content', userTrigger.charityName);
    $('.js-charity-label').popup();
    $('.js-trigger-label').popup();
  }
  var redirectUrl = "/auth/twitter/callback";
  if(user.twitter) {
    redirectUrl = "/triggers";
  }

  $('.connect-twitter').on('click', function (event) {
    event.preventDefault();
    var rawTrigger = localStorage.getItem('trigger');
    if(rawTrigger) {
      var userTrigger = JSON.parse(rawTrigger);
      delete userTrigger.charityName;
      userTrigger.social = true;
      jQuery.ajax({
        type: 'post',
        url: '/api/triggers',
        data: userTrigger,
        success: function () {
          console.log('Trigger', userTrigger, 'stored');
          localStorage.clear();
          window.location = redirectUrl;
        },
        dataType: 'json'
      });
    } else {
      window.location = '/triggers'
    }
  });

  $('.skip-link').on('click', function (event) {
    event.preventDefault();
    var rawTrigger = localStorage.getItem('trigger');
    if (rawTrigger) {
      var userTrigger = JSON.parse(rawTrigger);
      delete userTrigger.charityName;
      jQuery.ajax({
        type: 'post',
        url: '/api/triggers',
        data: userTrigger,
        success: function () {
          console.log('Trigger', userTrigger, 'stored');
          localStorage.clear();
          window.location = "/triggers";
        },
        dataType: 'json'
      });
    } else {
      window.location = "/triggers";
    }
  });

  // User selected a trigger from the dropdown
  $('.js-select-trigger').on('click', 'div.item', function () {
    var term = $(this).text().trim();
    loadTweets(term);
  });
  // User selected a trigger from the dropdown
  $('.js-select-trigger').on('keyup', function (e) {
    if (e.which === 13) {
      var term = $('input[name=trigger]').val()
      if ($('.js-tweet-drawer').hasClass('visible')) {
        loadTweets(term);
      }
    }
  });
  // User selected a charity from dropdown
  $('.js-select-charity .item').on('click', function () {

  });
});

function loadTweets(term) {
  var url = '/api/tweets/search?q=' + encodeURIComponent(term);
  jQuery.getJSON(url, function (data) {
    $('.tweets').empty();
    if (data.tweets && data.tweets.length !== 0) {
      var tweetsHTML = ""
      for (var i = 0; i < data.tweets.length; i++) {
        tweetsHTML += tweetHtml(data.tweets[i]._id)
      }
      $('.tweets').append(tweetsHTML);
      updateTweetCount(data.count);
      twttr.widgets.load();
    } else {
      $('.tweets').append('<p style="text-align: center; font-size: 20px; margin-top: 30px">No tweets</p>')
      updateTweetCount(0);
    }
    updateTweetTerm(term);
  });
}

function updateTweetTerm(term) {
  $('.js-tweet-term').empty();
  $('.js-tweet-term').text(term);
}

function landingDonate() {
  var charity = $('input[name=charity]').val().trim();
  var trigger = $('input[name=trigger]').val().trim();
  var amount = ($('.amount-other a').hasClass('selected-amount')) ? $('input[name=amount]').val() : $('.selected-amount').text();
  amount = amount.replace('$', '').trim();
  var charityName;
  charities.forEach(function(c) {
    if(c.ein === charity) {
      charityName = c.name;
    }
  });
  var userTrigger = {
    "charityId": charity,
    "name": trigger,
    "amount": amount,
    "charityName": charityName
  }
  var errors = validateTrigger(userTrigger);
  if (!errors) {
    if (user) { // User signed in, store in db
      localStorage.setItem('trigger', JSON.stringify(userTrigger));
      if (user.paymentToken) {
        window.location.replace('/social');
      } else {
        window.location.replace('/payment');
      }
    }
    else { // The user is not signed in
      localStorage.setItem('trigger', JSON.stringify(userTrigger));
      window.location.replace("/login");
    }
  } else {
  }
}

function updateTweetCount(num) {
  $('.js-tweet-count').empty();
  var number = '(' + num + ')';
  $('.js-tweet-count').text(number);
}

function validateTrigger(trigger) {
  var errors = [];
  if (!trigger.charityId || trigger.charityId.length !== 10) {
    errors.push({
      id: "",
      prompt: "Choose a charity"
    });
  }
  if (!trigger.name || trigger.name.length === 0) {
    errors.push({
      id: "",
      prompt: "Type a trigger"
    });
    $('.js-select-trigger input').addClass('error');

  }
  if (!trigger.amount) {
    errors.push({
      id: "",
      prompt: "Select an amount"
    });
  }
  if (errors.length === 0) {
    return false;
  }
  return errors;
}

function noLinkReload() {
  $('.js-word-cloud').on('click', 'a', function (event) {
    event.preventDefault();
    var trigger = getClickedLabel($(this).attr('href'));
    if(trigger) {
      $('input[name="trigger"]').val(trigger);
      $('.js-trigger-text').text(trigger);
      if ($('.js-tweet-drawer').hasClass('visible')) {
        loadTweets(term);
      }
    }
  });
}

function getClickedLabel(text) {
  if(text) {
    return text.replace('?word=', '');
  }
}

function twitterUrl(id) {
  return "https://twitter.com/realDonaldTrump/status/" + id
}

function tweetHtml(id) {
  var html = '<div class="tweet-embed"><blockquote class="twitter-tweet tw-align-center" data-lang="en" data-conversation="none"><a class="tweet-link" href="' + twitterUrl(id) + '"></a></blockquote></div>';
  return html;
}
